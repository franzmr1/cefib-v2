generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// ENUMS EXISTENTES (SIN CAMBIOS)
// ==========================================
enum UserRole {
  ADMIN
  SUPER_ADMIN
}

enum EstadoCurso {
  ACTIVO
  INACTIVO
  BORRADOR
  ARCHIVADO
}

enum Modalidad {
  PRESENCIAL
  VIRTUAL
  HIBRIDO
}

// ==========================================
// ENUMS NUEVOS (PARA DOCENTES Y PARTICIPANTES)
// ==========================================
enum TipoDocumento {
  DNI
  CARNET_EXTRANJERIA
  PASAPORTE
  RUC
}

enum EstadoDocente {
  ACTIVO
  INACTIVO
}

enum EstadoAsignacion {
  ACTIVO
  FINALIZADO
}

enum EstadoParticipante {
  ACTIVO
  INACTIVO
}

enum EstadoPago {
  PAGADO
  PENDIENTE
  NO_PAGADO
}

enum MetodoPago {
  EFECTIVO
  TRANSFERENCIA
  YAPE
  PLIN
  TARJETA
  OTRO
}

// ==========================================
// MODELO: User (ACTUALIZADO - Solo 1 relación nueva)
// ==========================================
model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  apellidos String?
  role      UserRole @default(ADMIN)
  image     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RELACIÓN EXISTENTE (NO CAMBIA)
  cursosCreados Curso[]
  inscripcionesRegistradas Inscripcion[]

  
  // ✅ NUEVA RELACIÓN (para saber quién registró la inscripción)
  solicitudesAsignadas     Solicitud[] @relation("SolicitudesAsignadas")
  refreshTokens            RefreshToken[]
  auditLogs                AuditLog[]


  @@map("users")
  @@index([email])
  @@index([role])
}

enum SectorCurso {
  GESTION_PUBLICA
  SALUD
  TECNOLOGIA
  EDUCACION
  PROYECTOS_PLANES
  ENERGIA_MINERIA
  OTRO
}
// ==========================================
// MODELO: Curso (ACTUALIZADO - 3 campos + 2 relaciones nuevas)
// ==========================================
model Curso {
  id               String       @id @default(cuid())
  titulo           String
  slug             String       @unique
  descripcion      String?      @db.Text
  descripcionBreve String? 
  imagenUrl        String? 
  fechaInicio      DateTime? 
  fechaFin         DateTime?
  duracionHoras    Int          @default(0)
  modalidad        Modalidad    @default(VIRTUAL)
  sector           SectorCurso?
  certificado      Boolean      @default(true)
  precio           Float?  
  cupoMaximo       Int?
  estado           EstadoCurso  @default(BORRADOR)
  
  // RELACIÓN EXISTENTE (NO CAMBIA)
  creadorId String
  creador   User   @relation(fields: [creadorId], references: [id], onDelete: Cascade)
  
  // ✅ NUEVO CAMPO: Para llevar control de inscritos
  cupoActual       Int          @default(0)
  
  // ✅ NUEVAS RELACIONES
  docentes         CursoDocente[]
  inscripciones    Inscripcion[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cursos")
  @@index([estado])
  @@index([creadorId])
  @@index([slug])
}

// ==========================================
// MODELO NUEVO: Docente
// ==========================================
model Docente {
  id                String   @id @default(cuid())
  
  // Datos Personales
  nombres           String
  apellidos         String
  tipoDocumento     TipoDocumento @default(DNI)
  numeroDocumento   String   @unique
  
  // Datos de Contacto
  email             String   @unique
  telefono          String?  
  celular           String
  direccion         String?
  
  // Datos Profesionales
  especialidad      String
  experiencia       String?    // Breve descripción
  
  // Estado
  estado            EstadoDocente @default(ACTIVO)
  
  // Relaciones
  cursosAsignados   CursoDocente[]
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("docentes")
  @@index([numeroDocumento])
  @@index([email])
  @@index([estado])
}

// ==========================================
// MODELO NUEVO: Relación Curso-Docente
// ==========================================
model CursoDocente {
  id              String   @id @default(cuid())
  
  cursoId         String
  curso           Curso    @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  
  docenteId       String
  docente         Docente  @relation(fields: [docenteId], references: [id], onDelete: Cascade)
  
  fechaAsignacion DateTime @default(now())
  estado          EstadoAsignacion @default(ACTIVO)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([cursoId, docenteId])
  @@map("curso_docente")
  @@index([cursoId])
  @@index([docenteId])
}

// ==========================================
// MODELO NUEVO: Participante/Estudiante
// ==========================================
model Participante {
  id                  String   @id @default(cuid())
  
  // Datos Personales
  nombres             String
  apellidos           String
  tipoDocumento       TipoDocumento @default(DNI)
  numeroDocumento     String   @unique
  
  // Datos de Contacto
  email               String   @unique
  telefono            String? 
  celular             String
  direccion           String?
  
  // Estado
  estado              EstadoParticipante @default(ACTIVO)
  
  // Relaciones
  inscripciones       Inscripcion[]
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("participantes")
  @@index([numeroDocumento])
  @@index([email])
  @@index([estado])
}

// ==========================================
// MODELO NUEVO: Inscripción
// ==========================================
model Inscripcion {
  id                    String   @id @default(cuid())
  codigo                String   @unique  // Auto: INS-2025-00001
  
  // Relaciones
  participanteId        String
  participante          Participante @relation(fields: [participanteId], references: [id], onDelete: Cascade)
  
  cursoId               String
  curso                 Curso    @relation(fields: [cursoId], references: [id], onDelete: Cascade)
  
  // Control
  fechaInscripcion      DateTime @default(now())
  
  // Estado de Pago
  estadoPago            EstadoPago @default(PENDIENTE)
  montoPagado           Float    @default(0)
  fechaPago             DateTime?
  metodoPago            MetodoPago?  
  
  // Asistencia
  asistio               Boolean  @default(false)
  observaciones         String?
  
  // Auditoría (quién registró la inscripción)
  registradoPorId       String
  registradoPor         User     @relation(fields: [registradoPorId], references: [id])
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@unique([participanteId, cursoId])
  @@map("inscripciones")
  @@index([cursoId])
  @@index([participanteId])
  @@index([estadoPago])
  @@index([registradoPorId])
}

// ============================================
// MÓDULO: SOLICITUDES DE PROGRAMAS PERSONALIZADOS
// Autor: Franz (@franzmr1)
// Fecha: 2025-11-26
// ============================================

model Solicitud {
  id                String   @id @default(cuid())
  folio             String   @unique @default(cuid())
  
  // Datos del solicitante
  nombres           String
  email             String
  telefono          String?
  empresa           String?
  cargo             String?
  
  // Detalles de la solicitud
  servicioInteres   ServicioSolicitud
  tipoPrograma      TipoProgramaSolicitud @default(INDIVIDUAL)
  numParticipantes  Int? 
  mensaje           String    @db.Text
  comoNosConociste  String?
  
  // Gestión interna (ADMIN)
  estado            EstadoSolicitud @default(NUEVO)
  prioridad         PrioridadSolicitud @default(NORMAL)
  notasInternas     String?   @db.Text
  
  // Asignación a usuario admin (relación con User existente)
  asignadoA         String?
  asignadoUsuario   User?      @relation("SolicitudesAsignadas", fields: [asignadoA], references: [id], onDelete: SetNull)
  
  // Metadata de seguridad
  ip                String?
  userAgent         String?
  origen            String?
  
  // Consentimiento
  aceptoTerminos    Boolean   @default(false)
  
  // Timestamps
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  fechaContacto     DateTime?
  fechaCierre       DateTime?
  
  @@index([estado])
  @@index([servicioInteres])
  @@index([createdAt])
  @@index([asignadoA])
  @@map("solicitudes")
}

// ============================================
// ENUMS PARA SOLICITUDES
// ============================================

enum ServicioSolicitud {
  PROYECTOS_PLANES
  SALUD
  GESTION_PUBLICA
  EDUCACION
  TECNOLOGIA
  ENERGIA_MINERIA
  OTRO
}

enum TipoProgramaSolicitud {
  INDIVIDUAL
  CORPORATIVO
}

enum EstadoSolicitud {
  NUEVO
  EN_REVISION
  CONTACTADO
  EN_NEGOCIACION
  CERRADO_EXITOSO
  CERRADO_SIN_EXITO
  CANCELADO
}

enum PrioridadSolicitud {
  BAJA
  NORMAL
  ALTA
  URGENTE
}

// ============================================
// MÓDULO: REFRESH TOKENS (SEGURIDAD)
// Autor: Franz (@franzmr1)
// Fecha: 2025-11-27
// Descripción: Tokens de refresco para sesiones seguras
// ============================================

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  csrfToken String?

  // Relación con User existente
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

// ============================================
// MÓDULO: AUDIT LOGS (AUDITORÍA)
// Autor: Franz (@franzmr1)
// Fecha: 2025-11-27
// Descripción: Registro de acciones para auditoría de seguridad
// ============================================

model AuditLog {
  id        String   @id @default(cuid())
  
  // Usuario que realizó la acción (puede ser null si es anónimo)
  userId    String? 
  user      User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Acción realizada
  action    AuditAction
  
  // Entidad afectada (ej: "Curso", "User", "Inscripcion")
  entity    String? 
  entityId  String?
  
  // Detalles adicionales en JSON
  details   Json?
  
  // Metadata de seguridad
  ipAddress String?
  userAgent String? 
  
  // Resultado de la acción
  success   Boolean  @default(true)
  errorMessage String?
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([entity])
  @@index([createdAt])
  @@map("audit_logs")
}

// Tipos de acciones auditables
enum AuditAction {
  // Autenticación
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT
  TOKEN_REFRESH
  PASSWORD_CHANGE
  
  // Usuarios
  USER_CREATE
  USER_UPDATE
  USER_DELETE
  
  // Cursos
  CURSO_CREATE
  CURSO_UPDATE
  CURSO_DELETE
  CURSO_PUBLISH
  
  // Inscripciones
  INSCRIPCION_CREATE
  INSCRIPCION_UPDATE
  INSCRIPCION_DELETE
  
  // Docentes
  DOCENTE_CREATE
  DOCENTE_UPDATE
  DOCENTE_DELETE
  
  // Solicitudes
  SOLICITUD_UPDATE
  SOLICITUD_ASSIGN
  SOLICITUD_CLOSE
  
  // Newsletter
  NEWSLETTER_SUBSCRIBE
  
  // Otros
  ADMIN_ACCESS
  API_ERROR
}

// ============================================
// MÓDULO: NEWSLETTER
// Descripción: Suscripciones al newsletter
// ============================================

model Newsletter {
  id        String   @id @default(cuid())
  email     String   @unique
  
  // Estado
  activo    Boolean  @default(true)
  
  // Metadata
  ip        String?
  userAgent String?
  origen    String?  // De dónde se suscribió (ej: "home", "footer", etc.)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([email])
  @@index([activo])
  @@index([createdAt])
  @@map("newsletter")
}